---
name: mode-optimize
description: Apply when user requests refactoring, optimization, or performance improvement. Use for OPTIMIZE task type.
alwaysApply: false
---

# âš¡ Optimize Mode

**Goal:** Improve quality **WITHOUT changing behavior**.

## Process

1. Measure current state (baseline)
2. Identify main bottleneck
3. Propose improvements + predict results
4. Refactor by priority order
5. Compare before/after
6. Ensure tests still pass

## Evaluation Criteria

| Criterion | Tool | Good Threshold |
|-----------|------|----------------|
| Code complexity | Mypy, manual review | Cyclomatic < 10 |
| Type coverage | `uvx mypy src` | 100% (no `Any`) |
| Test coverage | `uvx pytest --cov` | > 80% for critical paths |
| Duplication | Manual review, grep | Follow DRY principles |
| File length | Manual review | < 200 lines/file |
| Function length | Manual review | < 50 lines/function |

## ML-Specific Metrics

- **Training time**: Measure before/after optimization
- **Memory usage**: Monitor during training runs
- **Model performance**: Ensure optimizations don't degrade metrics
- **MLflow overhead**: Check tracking performance impact

## Output Format

```markdown
## âš¡ OPTIMIZE

**Issue:** [slow / duplicate code / hard to maintain]

**Baseline:**
- LOC: X lines
- Complexity: X (cyclomatic)
- Duplication: X instances
- Type coverage: X%

---

### Bottleneck:
| Issue | Location | Severity |
|-------|----------|----------|
| [Description] | `file:line` | ðŸ”´ High |

### Proposal:
| Item | Before | After | Î” |
|------|--------|-------|---|
| LOC | 500 | 350 | -30% |
| Duplication | 3 instances | 0 | -100% |

### Regression Check:
- [ ] Tests still pass (`uvx pytest tests/`)
- [ ] Mypy passes (`uvx mypy src`)
- [ ] Behavior unchanged (verify with tests)
- [ ] Performance maintained or improved
```

## Python/ML Optimization Strategies

- **DRY violations**: Extract shared utilities (see reuse-first principles)
- **Type safety**: Replace `Any` with precise types
- **Code organization**: Split large files, extract modules
- **Performance**: Optimize hot paths, batch operations
- **MLflow**: Consolidate tracking setup, reduce overhead

## Principles

| âŒ DON'T | âœ… DO |
|----------|-------|
| Optimize prematurely | Measure first, optimize later |
| Change behavior | Keep behavior unchanged |
| Prioritize cleverness | Readability > Performance |
| Skip tests | Re-run tests (`uvx pytest`) |
| Break type safety | Maintain or improve type coverage |
| Ignore workspace rules | Follow reuse-first, SRP, DRY |
