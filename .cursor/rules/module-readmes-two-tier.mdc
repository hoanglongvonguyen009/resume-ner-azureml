---
name: module-readmes-two-tier
description: Rule package for two-tier module READMEs (generated + curated) with single-source-of-truth tooling.
alwaysApply: false
---

# Module READMEs Two-Tier Rule

## Overview

This rule owns the **two-tier module README behavior** (generated + curated) for all first-level modules under `src/`.

- **Generated tier**: Deterministic, auto-updated block owned by tooling.
- **Curated tier**: Hand-written prose that must **never** be auto-overwritten without explicit opt-in.

The **authoritative source of truth** for this rule is this `.mdc` file:

- Agents MUST treat `.cursor/rules/module-readmes-two-tier.mdc` as canonical.
- The implementation for this rule lives in the `module-readmes-two-tier/` package under `.cursor/rules/`.
- Any `RULE.md` in the package is a human-friendly mirror only and MUST not diverge from this file.

## Package Layout

All implementation for this rule is self-contained under:

- `.cursor/rules/module-readmes-two-tier/`
  - `scripts/`
  - `scripts/schemas/`
  - `scripts/fixtures/diffs/`
  - `scripts/fixtures/readmes/`
  - `tests/`

All automation related to module README updates MUST go through this package.

## Responsibilities

- Define how impacted modules are detected from `git diff` (single source of truth).
- Define how evidence for generated README content is collected.
- Define how the generated marker block in each README is rewritten safely and deterministically.
- Provide rule-local entrypoints for:
  - Updating READMEs (`docs_update.py`).
  - Checking for README drift (`docs_check.py`).

## Rule Loading & Usage

- Cursor loads this rule via `.cursor/rules/module-readmes-two-tier.mdc`.
- Supporting scripts are located under:
  - `.cursor/rules/module-readmes-two-tier/scripts/`
- To run the scripts locally (recommended conventions):
  - Update READMEs for the last commit:
    - `uvx python .cursor/rules/module-readmes-two-tier/scripts/docs_update.py --diff HEAD~1..HEAD`
  - Check for README drift for a PR (CI-style merge-base against main):
    - `uvx python .cursor/rules/module-readmes-two-tier/scripts/docs_check.py --diff origin/main...HEAD`

Future CI workflows MUST call these scripts rather than re-implementing logic elsewhere.

## Two-Tier README Pattern

- Each top-level `src/<module>/README.md` is split into:
  - **Generated tier**: A block delimited by:
    - `<!-- AUTO-GENERATED:START -->`
    - `<!-- AUTO-GENERATED:END -->`
  - **Curated tier**: Everything outside the generated marker block.

### Generated Tier

- Owned by:
  - `changed_modules.py`
  - `collect_module_evidence.py`
  - `update_generated_block.py`
  - `docs_update.py`
- Deterministic:
  - No timestamps.
  - No absolute machine paths.
  - Stable sorting for lists and trees.
- Idempotent:
  - Running the updater twice with no code changes should produce no diff.

### Curated Tier

- Owned by humans (maintainers, documentation authors).
- Outside the scope of automatic rewrite by default.

**Curated-tier policy (initial version):**

- Curated-tier automation MUST start in **suggest-only** mode.
- Any future automation for curated prose MUST:
  - Emit proposed patches/diffs instead of writing directly to files by default.
  - Require an explicit, documented repository-level opt-in before enabling auto-write behavior.
- There MUST be no code path where curated-tier text is silently rewritten without explicit opt-in.

An optional script `update_curated_tier.py` may exist as a suggestion engine only. It MUST NOT write to files directly in its initial form.

## Single-Source-of-Truth Contracts

- **Impacted modules**:
  - The only supported way to compute impacted modules from a diff is:
    - `.cursor/rules/module-readmes-two-tier/scripts/changed_modules.py`
- **Generated marker writer**:
  - The only supported writer for the generated marker block is:
    - `.cursor/rules/module-readmes-two-tier/scripts/update_generated_block.py`
- **Docs update / check orchestration**:
  - `docs_update.py` orchestrates:
    - `changed_modules.py` → `collect_module_evidence.py` → `update_generated_block.py`
  - `docs_check.py` runs `docs_update.py` in non-interactive check mode and fails if any README drift is detected.

Any new tooling that needs impacted-module detection or generated-block updates MUST call these scripts rather than re-implementing logic.

## CI and Local Workflows

- Local developer workflow:
  - Run `docs_update.py` with an appropriate `--diff` range before committing:
    - Example: `uvx python .cursor/rules/module-readmes-two-tier/scripts/docs_update.py --diff HEAD~1..HEAD`
- CI workflow (recommended baseline):
  - Run `docs_check.py` against the PR diff range (e.g., `origin/main...HEAD`).
  - Fail the job if any `src/**/README.md` files would be changed by the updater.

Documentation for these workflows MUST be kept in sync in:

- `.cursor/rules/module-readmes-two-tier.mdc` (canonical).
- `.cursor/rules/module-readmes-two-tier/README.md` (human-friendly mirror).

